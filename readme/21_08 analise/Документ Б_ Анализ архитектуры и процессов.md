# Документ Б: Анализ архитектуры и процессов

## 📋 Метаданные документа
- **Проект:** Tiger Tech - IronBrain Drone Control System
- **Дата аудита:** 21 августа 2025
- **Версия:** 1.0
- **Аудитор:** Manus AI Technical Audit

---

## 🎯 Краткое резюме

**Статус архитектуры:** ⚠️ **СЛОЖНАЯ ГИБРИДНАЯ СИСТЕМА**

Проект представляет собой многоуровневую распределенную систему управления дронами, включающую веб-интерфейс, облачную инфраструктуру, бортовые компьютеры и автопилоты. Архитектура функциональна, но имеет проблемы с документированием, мониторингом и отказоустойчивостью.

---

## 🏗️ Архитектурная схема системы

### **Общая архитектура**

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web Frontend  │    │   VPS Server    │    │  Jetson Nano    │
│                 │    │                 │    │                 │
│ React/TypeScript│◄──►│ Python APIs     │◄──►│ Python Scripts  │
│ Mission Planner │    │ MAVLink Proxy   │    │ Camera Control  │
│ Drone Control   │    │ SSH Tunnels     │    │ Thermal Imaging │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Supabase DB   │    │   Monitoring    │    │  Orange Cube    │
│                 │    │                 │    │                 │
│ PostgreSQL+RLS  │    │ System Services │    │ ArduPilot/PX4   │
│ Edge Functions  │    │ Health Checks   │    │ MAVLink Proto   │
│ Real-time Subs  │    │ Log Aggregation │    │ Flight Control  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### **Компоненты системы**

#### 1. **Frontend Layer (React/TypeScript)**
- **Расположение:** `src/components/`
- **Технологии:** Vite, React 18, TypeScript, Tailwind CSS, shadcn-ui
- **Ключевые модули:**
  - `MissionPlanner.tsx` - Планирование миссий
  - `DroneControlProduction.jsx` - Управление дронами
  - `GlobalMap/` - Картографический интерфейс
  - `SOCPanel/` - Панель мониторинга

#### 2. **Backend Layer (VPS Server)**
- **Сервер:** Ubuntu 22.04.5 LTS (87.120.254.156)
- **Сервисы:**
  ```
  drone-control-api-v2.service    # Основной API v2
  drone-control-api.service       # Legacy API v1
  ironbrain-drone-api.service     # IronBrain API
  mavlink-proxy.service           # MAVLink прокси
  jetson-tunnels-monitor.service  # Мониторинг туннелей
  ```
- **Порты:**
  - 3001, 3002 - Python API endpoints
  - 5432 - PostgreSQL (локальный)
  - 2222 - SSH туннель к Jetson
  - 9999 - Дополнительный Python сервис
  - 14550 - MAVLink UDP

#### 3. **Edge Computing Layer (Jetson Nano)**
- **Устройство:** NVIDIA Jetson Nano
- **ОС:** Ubuntu 18.04.6 LTS (aarch64)
- **IP:** 192.168.1.236/24
- **Функции:**
  - Обработка видеопотока
  - Тепловизионная съемка
  - Локальная обработка данных
  - Связь с автопилотом

#### 4. **Flight Control Layer (Orange Cube)**
- **Автопилот:** Orange Cube/Pixhawk
- **Прошивка:** ArduPilot/PX4
- **Протокол:** MAVLink
- **Подключение:** USB/Serial к Jetson Nano

#### 5. **Database Layer (Supabase)**
- **Тип:** PostgreSQL с Supabase расширениями
- **Проект:** zqnjgwrvvrqaenzmlfvx.supabase.co
- **Функции:**
  - Row Level Security (RLS)
  - Real-time subscriptions
  - Edge Functions
  - Authentication

---

## 🔄 Процессы и потоки данных

### **1. Поток планирования миссии**

```
Оператор → Web UI → Supabase → VPS API → Jetson → Orange Cube
    ↓         ↓         ↓         ↓         ↓         ↓
Создание   Валидация  Сохранение  Передача  Подготовка  Выполнение
миссии     данных     в БД        команд    системы     миссии
```

**Детали процесса:**
1. **Планирование (Web UI)**
   - Оператор создает миссию в MissionPlanner
   - Выбор типа: survey_area, perimeter_patrol, point_inspection
   - Настройка параметров и маршрута

2. **Валидация (Frontend)**
   - Проверка корректности координат
   - Валидация параметров полета
   - Расчет времени выполнения

3. **Сохранение (Supabase)**
   - Запись миссии в БД
   - Применение RLS политик
   - Уведомление подписчиков

4. **Передача (VPS → Jetson)**
   - Отправка через SSH туннель
   - Конвертация в MAVLink команды
   - Буферизация команд

5. **Выполнение (Orange Cube)**
   - Получение MAVLink команд
   - Управление полетом
   - Отправка телеметрии

### **2. Поток телеметрии**

```
Orange Cube → Jetson → VPS → Supabase → Web UI → Оператор
     ↓          ↓       ↓       ↓         ↓         ↓
MAVLink    Обработка  Агрегация  Сохранение  Отображение  Мониторинг
данные     и фильтрация данных   в БД       в реальном   состояния
                                           времени
```

### **3. Поток видеоданных**

```
USB Camera → Jetson → VPS → Web UI → Оператор
     ↓         ↓       ↓       ↓         ↓
Захват    Обработка  Стриминг  Отображение  Просмотр
кадров    и сжатие   по HTTP   в браузере   видео
```

---

## 🔧 Технические процессы

### **Развертывание системы**

#### Текущий процесс (недокументированный):
1. Настройка VPS сервера
2. Установка Python зависимостей
3. Конфигурация Supabase
4. Настройка Jetson Nano
5. Прошивка Orange Cube
6. Настройка SSH туннелей
7. Запуск сервисов

**⚠️ ПРОБЛЕМА:** Процесс не документирован и выполняется вручную

### **Мониторинг и логирование**

#### Текущее состояние:
- ✅ Systemd сервисы с автозапуском
- ✅ SSH туннели с мониторингом
- ⚠️ Логи не централизованы
- ❌ Отсутствует мониторинг производительности
- ❌ Нет алертов при сбоях

### **Обновление системы**

#### Текущий процесс:
- ❌ Отсутствует CI/CD
- ❌ Ручное обновление компонентов
- ❌ Нет версионирования развертываний
- ❌ Отсутствует rollback механизм

---

## 🔍 Анализ архитектурных решений

### **✅ СИЛЬНЫЕ СТОРОНЫ**

#### 1. **Модульность**
- Четкое разделение на слои
- Независимые компоненты
- Возможность горизонтального масштабирования

#### 2. **Технологический стек**
- Современные технологии (React, TypeScript)
- Надежная БД (PostgreSQL/Supabase)
- Проверенные протоколы (MAVLink)

#### 3. **Real-time возможности**
- WebSocket соединения через Supabase
- Мгновенная синхронизация данных
- Live телеметрия

#### 4. **Безопасность на уровне БД**
- Row Level Security (RLS)
- Аутентификация через Supabase Auth
- Политики доступа на основе ролей

### **❌ СЛАБЫЕ СТОРОНЫ**

#### 1. **Единые точки отказа**
- VPS сервер - критическая точка
- SSH туннели - хрупкие соединения
- Отсутствие резервирования

#### 2. **Сложность развертывания**
- Множество компонентов для настройки
- Ручная конфигурация
- Отсутствие автоматизации

#### 3. **Мониторинг и наблюдаемость**
- Нет централизованного логирования
- Отсутствует метрики производительности
- Нет системы алертов

#### 4. **Масштабируемость**
- Жесткая привязка к одному Jetson
- Нет поддержки множественных дронов
- Ограничения пропускной способности

---

## 🚨 Архитектурные риски

### **🔴 КРИТИЧЕСКИЕ РИСКИ**

#### 1. **Отказоустойчивость**
- **Проблема:** Нет резервирования критических компонентов
- **Воздействие:** Полная остановка системы при сбое VPS
- **Вероятность:** Средняя
- **Решение:** Настроить кластер VPS или cloud failover

#### 2. **Безопасность сети**
- **Проблема:** SSH туннели без дополнительной защиты
- **Воздействие:** Компрометация бортовых систем
- **Вероятность:** Низкая
- **Решение:** VPN, сертификаты, мониторинг соединений

#### 3. **Производительность**
- **Проблема:** Нет мониторинга производительности
- **Воздействие:** Деградация системы незаметна до критического состояния
- **Вероятность:** Высокая
- **Решение:** Внедрить APM решение

### **🟡 СРЕДНИЕ РИСКИ**

#### 4. **Совместимость версий**
- **Проблема:** Разные версии Python на Jetson (3.6) и VPS (3.8+)
- **Воздействие:** Проблемы совместимости библиотек
- **Вероятность:** Средняя
- **Решение:** Контейнеризация или обновление Jetson

#### 5. **Пропускная способность**
- **Проблема:** Видеопоток через SSH туннель
- **Воздействие:** Задержки в видео, потеря кадров
- **Вероятность:** Высокая
- **Решение:** Прямое соединение или оптимизация сжатия

---

## 👥 Взгляд пользователя/оператора

### **Оператор дрона**

#### Ожидания:
- 🎯 Простое планирование миссий
- 📱 Интуитивный интерфейс управления
- 📊 Мгновенная телеметрия
- 📹 Качественный видеопоток
- ⚡ Быстрая реакция системы

#### Реальность:
- ✅ Интерфейс современный и удобный
- ✅ Планирование миссий реализовано
- ⚠️ Телеметрия работает, но могут быть задержки
- ⚠️ Видеопоток зависит от качества связи
- ❌ Нет индикаторов состояния системы

### **Системный администратор**

#### Ожидания:
- 🔧 Простое развертывание
- 📊 Полный мониторинг
- 🚨 Система алертов
- 🔄 Автоматические обновления
- 📋 Подробные логи

#### Реальность:
- ❌ Развертывание сложное и ручное
- ❌ Мониторинг фрагментарный
- ❌ Алерты отсутствуют
- ❌ Обновления только ручные
- ⚠️ Логи разбросаны по системе

### **Разработчик**

#### Ожидания:
- 📚 Четкая архитектурная документация
- 🧪 Среда для тестирования
- 🔄 CI/CD pipeline
- 📦 Контейнеризация
- 🐛 Инструменты отладки

#### Реальность:
- ❌ Архитектурная документация отсутствует
- ❌ Тестовая среда не настроена
- ❌ CI/CD отсутствует
- ❌ Контейнеры не используются
- ⚠️ Отладка через SSH и логи

---

## 🎯 Риски и быстрые победы (Quick Wins)

### **🚀 БЫСТРЫЕ ПОБЕДЫ (Quick Wins)**

#### Неделя 1:
1. **Создать архитектурную диаграмму** (4 часа)
   - Визуализировать текущую архитектуру
   - Показать потоки данных
   - Выделить критические компоненты

2. **Настроить централизованное логирование** (6 часов)
   - Собрать логи всех сервисов в одном месте
   - Настроить ротацию логов
   - Добавить структурированное логирование

3. **Создать health check endpoints** (4 часа)
   - Добавить /health для всех API
   - Проверка состояния БД и внешних сервисов
   - Мониторинг SSH туннелей

#### Неделя 2:
4. **Настроить базовый мониторинг** (8 часов)
   - Установить Prometheus + Grafana
   - Мониторинг системных метрик
   - Дашборды для ключевых показателей

5. **Документировать процесс развертывания** (6 часов)
   - Пошаговые инструкции
   - Скрипты автоматизации
   - Чек-листы для проверки

#### Месяц 1:
6. **Создать Docker контейнеры** (16 часов)
   - Контейнеризировать Python API
   - Docker Compose для локальной разработки
   - Унификация окружений

### **🔴 КРИТИЧЕСКИЕ УЛУЧШЕНИЯ**

#### Квартал 1:
1. **Внедрить отказоустойчивость** (40 часов)
   - Настроить load balancer
   - Резервирование критических сервисов
   - Автоматический failover

2. **Создать CI/CD pipeline** (32 часов)
   - Автоматическое тестирование
   - Автоматическое развертывание
   - Rollback механизм

3. **Оптимизировать производительность** (24 часа)
   - Профилирование узких мест
   - Оптимизация видеопотока
   - Кэширование данных

---

## 📏 Definition of Done (DoD)

### **Критерии завершенности архитектурных улучшений:**

#### 1. **Документация архитектуры**
- [ ] Создана C4 диаграмма архитектуры
- [ ] Документированы все компоненты и их взаимодействие
- [ ] Описаны потоки данных и протоколы
- [ ] Создана схема развертывания
- [ ] Документированы процедуры восстановления

#### 2. **Мониторинг и наблюдаемость**
- [ ] Настроено централизованное логирование
- [ ] Внедрены метрики производительности
- [ ] Созданы дашборды мониторинга
- [ ] Настроены алерты для критических событий
- [ ] Документированы runbook'и для операторов

#### 3. **Отказоустойчивость**
- [ ] Устранены единые точки отказа
- [ ] Настроено резервирование критических компонентов
- [ ] Внедрен автоматический failover
- [ ] Проведены тесты отказоустойчивости
- [ ] Документированы процедуры восстановления

#### 4. **Автоматизация**
- [ ] Создан CI/CD pipeline
- [ ] Автоматизировано развертывание
- [ ] Настроены автоматические тесты
- [ ] Внедрен rollback механизм
- [ ] Созданы скрипты для рутинных операций

### **Метрики успеха:**
- **Время развертывания:** < 15 минут (автоматически)
- **Время восстановления (RTO):** < 5 минут
- **Потеря данных (RPO):** < 1 минута
- **Доступность системы:** > 99.5%
- **Время отклика API:** < 200ms (95 перцентиль)

---

## 🔄 Рекомендации по улучшению архитектуры

### **Приоритет 1 (Критично - выполнить немедленно):**
1. **Создать архитектурную документацию**
   - Диаграммы компонентов и потоков данных
   - Описание интерфейсов между компонентами
   - Документация протоколов связи

2. **Настроить базовый мониторинг**
   - Health checks для всех сервисов
   - Централизованное логирование
   - Алерты для критических сбоев

3. **Устранить единые точки отказа**
   - Резервирование VPS сервера
   - Дублирование SSH туннелей
   - Backup стратегия для БД

### **Приоритет 2 (Высокий - выполнить в течение месяца):**
1. **Автоматизировать развертывание**
   - Infrastructure as Code (Terraform/Ansible)
   - Docker контейнеризация
   - CI/CD pipeline

2. **Оптимизировать производительность**
   - Профилирование узких мест
   - Оптимизация сетевого трафика
   - Кэширование данных

3. **Улучшить безопасность**
   - VPN вместо SSH туннелей
   - Сертификаты для всех соединений
   - Аудит безопасности

### **Приоритет 3 (Средний - выполнить в течение квартала):**
1. **Масштабируемость**
   - Поддержка множественных дронов
   - Горизонтальное масштабирование API
   - Микросервисная архитектура

2. **Расширенная аналитика**
   - Сбор и анализ телеметрии
   - Machine Learning для предиктивной аналитики
   - Оптимизация маршрутов полета

---

*Документ создан: 21 августа 2025*  
*Следующий обзор: 28 августа 2025*


---

## 🛰️ ДОПОЛНЕНИЕ: Архитектура с учетом STARLINK

### **🚨 КРИТИЧЕСКИЕ ИЗМЕНЕНИЯ АРХИТЕКТУРЫ**

#### **Текущая архитектура (НЕ РАБОТАЕТ с STARLINK):**
```
Internet
    │
    ▼
VPS (87.120.254.156) ──SSH:2222──► Jetson Nano
    │                              │
    ▼                              ▼
Web Interface                   Orange Cube
```

#### **Требуемая архитектура для STARLINK:**
```
STARLINK (CGNAT)
    │ (Исходящие соединения)
    ▼
Internet ──► VPS (87.120.254.156)
              │ ▲
              │ │ Reverse Tunnels
              │ │ WebSocket/HTTPS
              ▼ │
           Jetson Nano
              │
              ▼
           Orange Cube
```

### **🔧 Адаптированные компоненты**

#### **1. Связь Jetson ↔ VPS**
```python
# СТАРЫЙ СПОСОБ (не работает через STARLINK)
ssh root@87.120.254.156 -p 2222  # Входящее соединение

# НОВЫЙ СПОСОБ (работает через STARLINK)
# Reverse SSH tunnel от Jetson к VPS
ssh -R 2222:localhost:22 -R 14550:localhost:14550 root@87.120.254.156
```

#### **2. MAVLink через WebSocket**
```python
# СТАРЫЙ СПОСОБ
import socket
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.bind(('0.0.0.0', 14550))  # Не работает через NAT

# НОВЫЙ СПОСОБ
import websocket
ws = websocket.WebSocket()
ws.connect("wss://87.120.254.156/mavlink")
```

#### **3. Видеопоток с учетом upload ограничений**
```python
# Оптимизация для STARLINK upload (10-20 Mbps)
ffmpeg_cmd = [
    'ffmpeg',
    '-i', '/dev/video0',
    '-c:v', 'h264_nvenc',  # Аппаратное кодирование на Jetson
    '-b:v', '2M',          # Битрейт 2 Mbps (под upload лимит)
    '-maxrate', '3M',
    '-bufsize', '6M',
    '-preset', 'fast',
    '-tune', 'zerolatency',
    '-f', 'flv',
    'rtmp://87.120.254.156/live/stream'
]
```

### **📡 Сетевые адаптации**

#### **Keepalive настройки для нестабильного соединения:**
```bash
# SSH туннель с агрессивным keepalive
ssh -o ServerAliveInterval=30 \
    -o ServerAliveCountMax=3 \
    -o TCPKeepAlive=yes \
    -R 2222:localhost:22 root@87.120.254.156
```

#### **WebSocket reconnection logic:**
```javascript
class RobustWebSocket {
  constructor(url) {
    this.url = url;
    this.reconnectInterval = 5000;
    this.maxReconnectAttempts = 10;
    this.connect();
  }
  
  connect() {
    this.ws = new WebSocket(this.url);
    this.ws.onclose = () => {
      if (this.reconnectAttempts < this.maxReconnectAttempts) {
        setTimeout(() => this.connect(), this.reconnectInterval);
        this.reconnectAttempts++;
      }
    };
  }
}
```

### **🔄 Обновленные рекомендации с учетом STARLINK**

#### **Приоритет 0 (КРИТИЧНО - выполнить сегодня):**
1. **Настроить reverse SSH туннели**
   - Заменить прямые SSH соединения на reverse
   - Настроить autossh для автоматического переподключения
   - Тестировать стабильность соединения

2. **Адаптировать MAVLink для WebSocket**
   - Создать WebSocket bridge для MAVLink
   - Обеспечить надежное переподключение
   - Оптимизировать для нестабильного соединения

---

*Обновлено с учетом STARLINK архитектуры: 21 августа 2025*

